<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>First Bus â€” Bid Portfolio 2026â€“2030</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@azure/msal-browser@2.38.3/lib/msal-browser.min.js"
  onerror="(function(){var s=document.createElement('script');s.src='https://unpkg.com/@azure/msal-browser@2.38.3/lib/msal-browser.min.js';document.head.appendChild(s);})()">
</script>
<link href="https://fonts.googleapis.com/css2?family=DM+Mono:wght@400;500&family=Syne:wght@400;600;700;800&display=swap" rel="stylesheet">
<style>
  * { box-sizing: border-box; margin: 0; padding: 0; }
  html, body, #root { height: 100%; }
  body { background: #0a0d14; color: #f0f2f8; font-family: 'Syne', sans-serif; }
  ::-webkit-scrollbar { width: 6px; }
  ::-webkit-scrollbar-track { background: #111520; }
  ::-webkit-scrollbar-thumb { background: #1e2435; border-radius: 3px; }
  select, input, button { outline: none; font-family: 'Syne', sans-serif; }
  input[type="date"] { color-scheme: dark; cursor: pointer; }
  input[type="date"]::-webkit-calendar-picker-indicator { filter: invert(1); opacity: 0.7; cursor: pointer; }
  input[type="date"]::-webkit-calendar-picker-indicator:hover { opacity: 1; }
  @keyframes spin { to { transform: rotate(360deg); } }
  @keyframes fadeIn { from { opacity: 0; transform: translateY(6px); } to { opacity: 1; transform: translateY(0); } }
  .fade-in { animation: fadeIn 0.25s ease forwards; }
</style>
</head>
<body>
<div id="root"></div>

<script type="text/babel">
const { useState, useMemo, useEffect, useRef, useCallback } = React;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// âš™ï¸  CONFIGURATION â€” FILL IN AFTER AZURE REGISTRATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const MS_CLIENT_ID = "53dc566b-d04e-4dfe-99cd-4713fc786c5a";
const EXCEL_FILE_NAME = "BidPortfolio.xlsx"; // name of your OneDrive Excel file
const EXCEL_TABLE = "BidData"; // table name inside the Excel file
const SETTINGS_TABLE = "AppSettings"; // settings table on the Settings tab
let EXCEL_FILE_ID = null; // resolved automatically on first load
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// â”€â”€ MSAL setup â”€â”€
// MSAL global detection - different CDNs expose different globals
const msalLib = window.msalBrowser || window["msal-browser"] || window.msal;
const msalConfig = {
  auth: {
    clientId: MS_CLIENT_ID,
    authority: "https://login.microsoftonline.com/consumers",
    redirectUri: window.location.origin + window.location.pathname,
  },
  cache: { cacheLocation: "localStorage", storeAuthStateInCookie: true },
};

const TOKEN_SCOPES = ["User.Read", "Files.ReadWrite"];

// â”€â”€ Default business logic settings â”€â”€
const DEFAULT_SETTINGS = {
  blendedRate: 85,
  hoursPerLeadPerWeek: 12,
  leadsPerBid: 10,
  totalLeads: 20,
  minMargin: 8,
  minWinProb: 20,
  maxBidCostPct: 5,
  mobilisationMonths: 9,
  concurrencyLimit: 2,
};

function loadSettings() {
  // Used as initial state only â€” real settings loaded from Excel after login
  try {
    const saved = localStorage.getItem("bidPortfolioSettings");
    return saved ? { ...DEFAULT_SETTINGS, ...JSON.parse(saved) } : { ...DEFAULT_SETTINGS };
  } catch { return { ...DEFAULT_SETTINGS }; }
}

function cacheSettings(s) {
  // Cache locally as fallback
  localStorage.setItem("bidPortfolioSettings", JSON.stringify(s));
}

// â”€â”€ Static options â”€â”€
const STAGES = ["Intake", "Qualified", "Submitted", "Won", "Lost", "No-Go"];
const REGIONS = ["North West", "Yorkshire", "West Midlands", "South West", "Scotland", "East Midlands", "South East", "North East"];
const COMPLIANCE_OPTS = ["Pass", "Fail", "TBC"];
const VIEWS = ["Dashboard", "Portfolio Grid", "Add Bid", "Settings"];

const GOColors = { GO: "#4BE8A0", "NO-GO": "#E84B7A", REVIEW: "#E8B84B", WON: "#4B9FE8", LOST: "#6b7280" };
const StageColors = { Intake: "#A04BE8", Qualified: "#4B9FE8", Submitted: "#E8B84B", Won: "#4BE8A0", Lost: "#6b7280", "No-Go": "#E84B7A" };
const CapColor = { OK: "#4BE8A0", OVER: "#E84B7A" };

// â”€â”€ Helpers â”€â”€
function addWeeks(dateStr, weeks) {
  if (!dateStr) return "";
  const d = new Date(dateStr);
  if (isNaN(d.getTime())) return "";
  d.setDate(d.getDate() + weeks * 7);
  return d.toISOString().slice(0, 10);
}
function addMonths(dateStr, months) {
  if (!dateStr) return "";
  const d = new Date(dateStr);
  if (isNaN(d.getTime()) || d.getFullYear() < 2000) return "";
  d.setMonth(d.getMonth() + months);
  return d.toISOString().slice(0, 10);
}
function fmtDate(d) {
  if (!d) return "â€”";
  return new Date(d).toLocaleDateString("en-GB", { day: "2-digit", month: "short", year: "numeric" });
}
function fmtCurrency(n) {
  if (n >= 1e6) return `Â£${(n / 1e6).toFixed(1)}m`;
  if (n >= 1e3) return `Â£${(n / 1e3).toFixed(0)}k`;
  return `Â£${n}`;
}
function fmtGBP(n) {
  return new Intl.NumberFormat("en-GB", { style: "currency", currency: "GBP", maximumFractionDigits: 0 }).format(n);
}
// Excel sends dates in multiple formats â€” serial numbers, M/D/YYYY, or ISO strings
// Always returns YYYY-MM-DD for HTML date inputs, or "" if invalid
function excelDateToISO(val) {
  if (!val && val !== 0) return "";

  // Already ISO format YYYY-MM-DD
  if (typeof val === "string" && /^\d{4}-\d{2}-\d{2}/.test(val)) {
    return val.slice(0, 10);
  }

  // Excel serial number (e.g. 45953) â€” days since 1900-01-01
  if (typeof val === "number" && val > 1000) {
    const d = new Date((val - 25569) * 86400 * 1000);
    if (!isNaN(d.getTime()) && d.getFullYear() > 2000) {
      return d.toISOString().slice(0, 10);
    }
  }

  // String date in M/D/YYYY or MM/DD/YYYY format (what Excel Graph API returns)
  if (typeof val === "string" && /^\d{1,2}\/\d{1,2}\/\d{4}$/.test(val.trim())) {
    const parts = val.trim().split("/");
    const month = parts[0].padStart(2, "0");
    const day = parts[1].padStart(2, "0");
    const year = parts[2];
    const iso = `${year}-${month}-${day}`;
    const d = new Date(iso);
    if (!isNaN(d.getTime()) && d.getFullYear() > 2000) return iso;
  }

  // Last resort â€” try native Date parsing
  if (typeof val === "string") {
    const d = new Date(val);
    if (!isNaN(d.getTime()) && d.getFullYear() > 2000) {
      return d.toISOString().slice(0, 10);
    }
  }

  return "";
}

function nextId(bids) {
  const nums = bids.map(b => parseInt(b.id.replace("BID", ""))).filter(n => !isNaN(n));
  return `BID${String((Math.max(0, ...nums) + 1)).padStart(3, "0")}`;
}

// â”€â”€ Row conversion â”€â”€
// Columns: Bid ID | Authority | Name | Region | Stage | Bid Start | Duration Weeks | Contract Value | Win Prob | Target Margin | Strategic Score | Compliance | Decision Owner | Award Date | Notes
function rowToBid(row, idx) {
  if (!row || row.length < 3) return null;
  return {
    id: row[0] || "",
    authority: row[1] || "",
    name: row[2] || "",
    region: row[3] || "",
    stage: row[4] || "Intake",
    bidStart: excelDateToISO(row[5]) || new Date().toISOString().slice(0, 10),
    bidDurationWeeks: Number(row[6]) || 20,
    contractValue: Number(row[7]) || 0,
    winProb: Number(row[8]) || 0,
    targetMargin: Number(row[9]) || 0,
    strategicScore: Number(row[10]) || 3,
    compliance: row[11] || "Pass",
    decisionOwner: row[12] || "",
    awardDate: excelDateToISO(row[13]),
    notes: row[14] || "",
    _rowIndex: idx,
  };
}
function bidToRow(bid) {
  return [bid.id, bid.authority, bid.name, bid.region, bid.stage, bid.bidStart,
    bid.bidDurationWeeks, bid.contractValue, bid.winProb, bid.targetMargin,
    bid.strategicScore, bid.compliance, bid.decisionOwner, bid.awardDate || "", bid.notes || ""];
}

// â”€â”€ Calculation engine â”€â”€
function calcBid(bid, allBids, settings) {
  const S = settings;
  const bidEnd = addWeeks(bid.bidStart, bid.bidDurationWeeks);
  const totalHours = S.leadsPerBid * S.hoursPerLeadPerWeek * bid.bidDurationWeeks;
  const bidPursuitCost = totalHours * S.blendedRate;
  const ev = bid.contractValue * (bid.winProb / 100);
  const bidCostPct = ev > 0 ? (bidPursuitCost / ev) * 100 : 999;

  const activeStages = ["Intake", "Qualified"];
  const overlapCount = allBids.filter(b => {
    if (b.id === bid.id || !activeStages.includes(b.stage)) return false;
    const bEnd = addWeeks(b.bidStart, b.bidDurationWeeks);
    return b.bidStart <= bidEnd && bEnd >= bid.bidStart;
  }).length;

  const capacityStatus = activeStages.includes(bid.stage) && overlapCount >= S.concurrencyLimit ? "OVER" : "OK";

  let goNoGo = "GO";
  const flags = [];
  if (bid.compliance === "Fail") { goNoGo = "NO-GO"; flags.push("Compliance fail"); }
  if (capacityStatus === "OVER") { goNoGo = "NO-GO"; flags.push("Capacity OVER"); }
  if (ev > 0 && bidPursuitCost >= ev) { goNoGo = "NO-GO"; flags.push(`Pursuit cost Â£${bidPursuitCost.toLocaleString()} exceeds EV Â£${ev.toLocaleString()}`); }
  if (bid.targetMargin < S.minMargin) { flags.push(`Margin ${bid.targetMargin}% < ${S.minMargin}%`); if (goNoGo === "GO") goNoGo = "REVIEW"; }
  if (bid.winProb < S.minWinProb) { flags.push(`Win prob ${bid.winProb}% < ${S.minWinProb}%`); if (goNoGo === "GO") goNoGo = "REVIEW"; }
  if (bidCostPct > S.maxBidCostPct) { flags.push(`Bid cost ${bidCostPct.toFixed(1)}% of EV`); if (goNoGo === "GO") goNoGo = "REVIEW"; }
  if (bid.compliance === "TBC") { flags.push("Compliance TBC"); if (goNoGo === "GO") goNoGo = "REVIEW"; }
  if (bid.stage === "Won") goNoGo = "WON";
  else if (bid.stage === "Lost") goNoGo = "LOST";
  else if (bid.stage === "No-Go") goNoGo = "NO-GO";

  const hasValidAwardDate = bid.awardDate && bid.awardDate.length >= 8 && !isNaN(new Date(bid.awardDate).getTime()) && new Date(bid.awardDate).getFullYear() > 2000;
  const mobilisationStart = bid.stage === "Won" && hasValidAwardDate ? bid.awardDate : null;
  const goLiveDate = mobilisationStart ? addMonths(mobilisationStart, S.mobilisationMonths) : null;

  return { ...bid, bidEnd, totalHours, bidPursuitCost, ev, bidCostPct, overlapCount, capacityStatus, goNoGo, flags, mobilisationStart, goLiveDate };
}

// â”€â”€ Shared components â”€â”€
function Badge({ label, color, small }) {
  return (
    <span style={{
      background: color + "22", color, border: `1px solid ${color}44`,
      borderRadius: 4, padding: small ? "1px 6px" : "2px 8px",
      fontSize: small ? 10 : 11, fontFamily: "'DM Mono',monospace",
      fontWeight: 500, whiteSpace: "nowrap", display: "inline-block"
    }}>{label}</span>
  );
}

function KpiCard({ label, value, sub, color, accent }) {
  return (
    <div style={{ background: "#111520", border: `1px solid ${accent || "#1e2435"}`, borderRadius: 10, padding: "20px 24px", flex: 1, minWidth: 140, position: "relative", overflow: "hidden" }}>
      {accent && <div style={{ position: "absolute", top: 0, left: 0, right: 0, height: 3, background: accent, borderRadius: "10px 10px 0 0" }} />}
      <div style={{ fontSize: 10, color: "#9CA3AF", fontFamily: "'DM Mono',monospace", letterSpacing: 1, textTransform: "uppercase", marginBottom: 10 }}>{label}</div>
      <div style={{ fontSize: 26, fontWeight: 800, color: color || "#f0f2f8", lineHeight: 1 }}>{value}</div>
      {sub && <div style={{ fontSize: 11, color: "#9CA3AF", marginTop: 6 }}>{sub}</div>}
    </div>
  );
}

function Spinner({ message }) {
  return (
    <div style={{ display: "flex", flexDirection: "column", alignItems: "center", justifyContent: "center", height: "60vh", gap: 16 }}>
      <div style={{ width: 36, height: 36, border: "2px solid #1e2435", borderTop: "2px solid #4B9FE8", borderRadius: "50%", animation: "spin 0.8s linear infinite" }} />
      <div style={{ color: "#9CA3AF", fontSize: 12, fontFamily: "'DM Mono',monospace" }}>{message}</div>
    </div>
  );
}

function inp(extra) {
  return {
    width: "100%", background: "#0d1119", border: "1px solid #1e2435", borderRadius: 7,
    color: "#f0f2f8", padding: "9px 12px", fontSize: 13, ...extra
  };
}
function lbl() {
  return { display: "block", fontSize: 10, color: "#9CA3AF", fontFamily: "'DM Mono',monospace", textTransform: "uppercase", letterSpacing: 1, marginBottom: 5 };
}

// â”€â”€ Microsoft Login Screen â”€â”€
function LoginScreen({ onSignIn, error, loading }) {
  return (
    <div style={{ minHeight: "100vh", background: "#0a0d14", display: "flex", alignItems: "center", justifyContent: "center" }}>
      <div className="fade-in" style={{ background: "#111520", border: "1px solid #1e2435", borderRadius: 16, padding: "48px 56px", textAlign: "center", maxWidth: 420, width: "90%" }}>
        <div style={{ width: 56, height: 56, background: "linear-gradient(135deg,#4B9FE8,#A04BE8)", borderRadius: 14, display: "flex", alignItems: "center", justifyContent: "center", fontSize: 26, margin: "0 auto 20px" }}>ğŸšŒ</div>
        <h1 style={{ fontSize: 24, fontWeight: 800, marginBottom: 6 }}>First Bus</h1>
        <p style={{ color: "#9CA3AF", fontSize: 12, fontFamily: "'DM Mono',monospace", marginBottom: 36, letterSpacing: 0.5 }}>Bid Portfolio Intelligence Â· 2026â€“2030</p>
        <button
          onClick={onSignIn}
          disabled={loading}
          style={{
            background: loading ? "#1e2435" : "#0078d4", color: "#fff", border: "none", borderRadius: 8,
            padding: "13px 28px", fontSize: 14, fontWeight: 700, cursor: loading ? "not-allowed" : "pointer",
            display: "flex", alignItems: "center", gap: 10, margin: "0 auto",
            opacity: loading ? 0.7 : 1, transition: "all 0.2s"
          }}>
          {loading ? (
            <div style={{ width: 16, height: 16, border: "2px solid #4B9FE8", borderTop: "2px solid transparent", borderRadius: "50%", animation: "spin 0.7s linear infinite" }} />
          ) : (
            <svg width="18" height="18" viewBox="0 0 21 21">
              <rect x="1" y="1" width="9" height="9" fill="#f25022"/>
              <rect x="11" y="1" width="9" height="9" fill="#7fba00"/>
              <rect x="1" y="11" width="9" height="9" fill="#00a4ef"/>
              <rect x="11" y="11" width="9" height="9" fill="#ffb900"/>
            </svg>
          )}
          {loading ? "Signing in..." : "Sign in with Microsoft"}
        </button>
        {error && <p style={{ color: "#E84B7A", fontSize: 12, marginTop: 16, fontFamily: "'DM Mono',monospace" }}>{error}</p>}
        <p style={{ color: "#374151", fontSize: 11, marginTop: 28, fontFamily: "'DM Mono',monospace" }}>Restricted to authorised users only</p>
      </div>
    </div>
  );
}

// â”€â”€ Settings Page â”€â”€
function SettingsPage({ settings, onSave }) {
  const [draft, setDraft] = useState({ ...settings });
  const [saved, setSaved] = useState(false);

  function handleSave() {
    onSave(draft);
    setSaved(true);
    setTimeout(() => setSaved(false), 2500);
  }
  function handleReset() {
    setDraft({ ...DEFAULT_SETTINGS });
  }

  const fields = [
    { key: "blendedRate", label: "Blended Team Rate", unit: "Â£/hr", desc: "Average hourly cost of the bid team" },
    { key: "hoursPerLeadPerWeek", label: "Hours per Lead per Week", unit: "hrs", desc: "Hours each lead contributes weekly to a bid" },
    { key: "leadsPerBid", label: "Leads per Bid", unit: "people", desc: "Number of leads assigned to each bid" },
    { key: "totalLeads", label: "Total Lead Capacity", unit: "people", desc: "Total leads available across the organisation" },
    { key: "concurrencyLimit", label: "Max Concurrent Bids", unit: "bids", desc: "Maximum number of active bids at one time" },
    { key: "minMargin", label: "Minimum Target Margin", unit: "%", desc: "Below this margin triggers a REVIEW flag" },
    { key: "minWinProb", label: "Minimum Win Probability", unit: "%", desc: "Below this probability triggers a REVIEW flag" },
    { key: "maxBidCostPct", label: "Max Bid Cost (% of EV)", unit: "%", desc: "Pursuit cost above this % of expected value triggers REVIEW" },
    { key: "mobilisationMonths", label: "Mobilisation Period", unit: "months", desc: "Time from award to go-live" },
  ];

  return (
    <div className="fade-in" style={{ maxWidth: 760, margin: "0 auto" }}>
      <div style={{ marginBottom: 28 }}>
        <h1 style={{ fontSize: 22, fontWeight: 800, marginBottom: 6 }}>Business Logic Settings</h1>
        <p style={{ color: "#9CA3AF", fontSize: 13, fontFamily: "'DM Mono',monospace" }}>
          Configure the assumptions that drive Go/No-Go decisions and viability calculations. Changes apply immediately to all bids.
        </p>
      </div>

      <div style={{ background: "#111520", border: "1px solid #1e2435", borderRadius: 12, overflow: "hidden", marginBottom: 20 }}>
        <div style={{ background: "#0d1119", padding: "14px 24px", borderBottom: "1px solid #1e2435" }}>
          <div style={{ fontSize: 10, color: "#9CA3AF", fontFamily: "'DM Mono',monospace", textTransform: "uppercase", letterSpacing: 1 }}>Calculation Parameters</div>
        </div>
        <div style={{ padding: 24, display: "grid", gridTemplateColumns: "1fr 1fr", gap: 20 }}>
          {fields.map(({ key, label, unit, desc }) => (
            <div key={key}>
              <label style={lbl()}>{label}</label>
              <div style={{ display: "flex", alignItems: "center", gap: 8 }}>
                <input
                  type="number"
                  value={draft[key]}
                  onChange={e => setDraft(p => ({ ...p, [key]: Number(e.target.value) }))}
                  style={{ ...inp(), flex: 1 }}
                />
                <span style={{ fontSize: 12, color: "#9CA3AF", fontFamily: "'DM Mono',monospace", whiteSpace: "nowrap" }}>{unit}</span>
              </div>
              <div style={{ fontSize: 11, color: "#4B5563", marginTop: 4 }}>{desc}</div>
            </div>
          ))}
        </div>
      </div>

      {/* Go/No-Go rule summary */}
      <div style={{ background: "#111520", border: "1px solid #1e2435", borderRadius: 12, overflow: "hidden", marginBottom: 24 }}>
        <div style={{ background: "#0d1119", padding: "14px 24px", borderBottom: "1px solid #1e2435" }}>
          <div style={{ fontSize: 10, color: "#9CA3AF", fontFamily: "'DM Mono',monospace", textTransform: "uppercase", letterSpacing: 1 }}>Current Decision Rules (live preview)</div>
        </div>
        <div style={{ padding: "18px 24px", display: "flex", flexDirection: "column", gap: 10 }}>
          {[
            { label: "NO-GO if compliance = Fail", color: "#E84B7A" },
            { label: `NO-GO if active bids exceed ${draft.concurrencyLimit}`, color: "#E84B7A" },
            { label: `REVIEW if margin < ${draft.minMargin}%`, color: "#E8B84B" },
            { label: `REVIEW if win probability < ${draft.minWinProb}%`, color: "#E8B84B" },
            { label: `REVIEW if bid cost > ${draft.maxBidCostPct}% of EV`, color: "#E8B84B" },
            { label: `Bid pursuit cost = ${draft.leadsPerBid} leads Ã— ${draft.hoursPerLeadPerWeek} hrs/wk Ã— Â£${draft.blendedRate}/hr Ã— duration`, color: "#4B9FE8" },
            { label: `Mobilisation period = ${draft.mobilisationMonths} months from award date`, color: "#4BE8A0" },
          ].map(({ label, color }) => (
            <div key={label} style={{ display: "flex", alignItems: "center", gap: 10 }}>
              <div style={{ width: 6, height: 6, borderRadius: "50%", background: color, flexShrink: 0 }} />
              <span style={{ fontSize: 12, color: "#9CA3AF", fontFamily: "'DM Mono',monospace" }}>{label}</span>
            </div>
          ))}
        </div>
      </div>

      <div style={{ display: "flex", gap: 12 }}>
        <button
          onClick={handleSave}
          style={{ background: "#4B9FE8", color: "#fff", border: "none", borderRadius: 8, padding: "11px 28px", fontSize: 13, fontWeight: 700, cursor: "pointer" }}>
          {saved ? "âœ“ Saved" : "Save Settings"}
        </button>
        <button
          onClick={handleReset}
          style={{ background: "transparent", color: "#9CA3AF", border: "1px solid #1e2435", borderRadius: 8, padding: "11px 20px", fontSize: 13, cursor: "pointer" }}>
          Reset to Defaults
        </button>
      </div>
    </div>
  );
}

// â”€â”€ Main App â”€â”€
function App() {
  const msalRef = useRef(null);
  const [authState, setAuthState] = useState("idle");
  const [authError, setAuthError] = useState("");
  const [accessToken, setAccessToken] = useState(null);
  const [userInfo, setUserInfo] = useState(null);
  const [bids, setBids] = useState([]);
  const [loading, setLoading] = useState(false);
  const [syncStatus, setSyncStatus] = useState("");
  const [refreshing, setRefreshing] = useState(false);
  const [view, setView] = useState("Dashboard");
  const [selectedBid, setSelectedBid] = useState(null);
  const [filterStage, setFilterStage] = useState("All");
  const [filterGNG, setFilterGNG] = useState("All");
  const [settings, setSettings] = useState(loadSettings);
  const [newBid, setNewBid] = useState({
    authority: "", name: "", region: REGIONS[0], stage: "Intake",
    bidStart: new Date().toISOString().slice(0, 10), bidDurationWeeks: 20,
    contractValue: "", winProb: "", targetMargin: "", strategicScore: 3,
    compliance: "Pass", decisionOwner: "", notes: ""
  });
  const [editDraft, setEditDraft] = useState(null);   // tracks edits in expanded row
  const [confirmDeleteId, setConfirmDeleteId] = useState(null); // id of bid pending delete confirm

  // silentLogin must be defined before useEffect references it
  async function silentLogin(account) {
    try {
      const resp = await msalRef.current.acquireTokenSilent({ scopes: TOKEN_SCOPES, account });
      finishLogin(resp);
    } catch (e) {
      console.log("Silent login failed, user must sign in again");
    }
  }

  // Init MSAL
  useEffect(() => {
    // client ID is set
    try {
      if (!msalLib || !msalLib.PublicClientApplication) {
        setAuthError("Authentication library failed to load. Hard-refresh (Ctrl+Shift+R) and try again.");
        return;
      }
      msalRef.current = new msalLib.PublicClientApplication(msalConfig);
      msalRef.current.initialize().then(() => {
        // Handle redirect response
        msalRef.current.handleRedirectPromise().then(resp => {
          if (resp) finishLogin(resp);
          else {
            // Only auto-resume if:
            // 1. User hasn't explicitly signed out (localStorage flag)
            // 2. There was an active session in this browser tab (sessionStorage flag)
            // sessionStorage clears when the tab closes, preventing cross-tab auto-login
            const signedOut = localStorage.getItem("bidPortfolio_signedOut");
            const hadSession = sessionStorage.getItem("bidPortfolio_session");
            if (!signedOut && hadSession) {
              const accounts = msalRef.current.getAllAccounts();
              if (accounts.length > 0) silentLogin(accounts[0]);
            }
          }
        });
      });
    } catch (e) { console.error("MSAL init error:", e); }
  }, []);


  async function finishLogin(resp) {
    const token = resp.accessToken;
    setAccessToken(token);
    setAuthState("authenticated");
    // Mark active session â€” used to gate silent login on refresh
    sessionStorage.setItem("bidPortfolio_session", "active");
    localStorage.removeItem("bidPortfolio_signedOut");
    // Get user profile
    try {
      const me = await fetch("https://graph.microsoft.com/v1.0/me", {
        headers: { Authorization: `Bearer ${token}` }
      }).then(r => r.json());
      setUserInfo({ name: me.displayName, email: me.mail || me.userPrincipalName });
    } catch (e) { console.log("Profile fetch failed", e); }
    loadBids(token);
    loadSettingsFromExcel(token);
  }

  async function handleSignIn() {
    if (!msalRef.current) {
      setAuthError("App not configured yet â€” please add your Azure Client ID.");
      return;
    }
    setAuthState("signing-in");
    setAuthError("");
    localStorage.removeItem("bidPortfolio_signedOut"); // clear flag on explicit sign-in
    try {
      const resp = await msalRef.current.loginPopup({ scopes: TOKEN_SCOPES });
      // After login, acquire token
      const tokenResp = await msalRef.current.acquireTokenSilent({
        scopes: TOKEN_SCOPES,
        account: resp.account
      });
      finishLogin(tokenResp);
    } catch (e) {
      setAuthState("idle");
      setAuthError("Sign in failed. Please try again.");
      console.error("Login error:", e);
    }
  }

  async function getToken() {
    if (!msalRef.current) return null;
    const accounts = msalRef.current.getAllAccounts();
    if (!accounts.length) return null;
    try {
      const resp = await msalRef.current.acquireTokenSilent({ scopes: TOKEN_SCOPES, account: accounts[0] });
      setAccessToken(resp.accessToken);
      return resp.accessToken;
    } catch (e) {
      // Silent failed â€” need interactive
      try {
        const resp = await msalRef.current.acquireTokenPopup({ scopes: TOKEN_SCOPES });
        setAccessToken(resp.accessToken);
        return resp.accessToken;
      } catch (e2) {
        setAuthState("idle");
        return null;
      }
    }
  }

  async function handleSignOut() {
    // Clear local state first so UI updates immediately
    setAccessToken(null);
    setUserInfo(null);
    setBids([]);
    setAuthState("idle");
    // Set flag so we don't auto-resume even if logout popup is blocked
    sessionStorage.removeItem("bidPortfolio_session");
    localStorage.setItem("bidPortfolio_signedOut", "true");
    // Actually end the Microsoft SSO session via popup
    // This prevents re-auth via M365 browser cookies on refresh
    try {
      if (msalRef.current) {
        const accounts = msalRef.current.getAllAccounts();
        if (accounts.length > 0) {
          await msalRef.current.logoutPopup({
            account: accounts[0],
            onRedirectNavigate: () => false, // don't redirect the main window
          });
        }
        msalRef.current.clearCache();
      }
    } catch(e) {
      // If popup is blocked or fails, the localStorage flag still prevents auto-login
      console.log("Logout popup closed or blocked:", e.message);
    }
    // Wipe all MSAL keys from storage
    Object.keys(localStorage).forEach(k => {
      if (k.includes("msal") || k.includes(MS_CLIENT_ID)) localStorage.removeItem(k);
    });
    Object.keys(sessionStorage).forEach(k => {
      if (k.includes("msal") || k.includes(MS_CLIENT_ID)) sessionStorage.removeItem(k);
    });
  }

  // â”€â”€ Excel API calls â”€â”€
  async function resolveFileId(t) {
    if (EXCEL_FILE_ID) return EXCEL_FILE_ID;
    const baseName = EXCEL_FILE_NAME.replace(".xlsx","").toLowerCase();
    // List all files in OneDrive root
    const resp = await fetch(
      `https://graph.microsoft.com/v1.0/me/drive/root/children?$top=100`,
      { headers: { Authorization: `Bearer ${t}` } }
    );
    const data = await resp.json();
    if (data.error) throw new Error("Drive error: " + data.error.message);
    const files = data.value || [];
    console.log("OneDrive root files:", files.map(f => f.name).join(", "));
    const file = files.find(f =>
      f.name === EXCEL_FILE_NAME ||
      f.name.toLowerCase() === baseName + ".xlsx" ||
      f.name.toLowerCase() === baseName
    );
    if (!file) throw new Error(`File "${EXCEL_FILE_NAME}" not found. Found: ${files.map(f=>f.name).join(", ")}`);
    EXCEL_FILE_ID = file.id;
    console.log("Resolved file:", file.name, "ID:", EXCEL_FILE_ID);
    return EXCEL_FILE_ID;
  }

  async function loadBids(token, silent) {
    if (silent) setRefreshing(true); else setLoading(true);
    try {
      const t = token || await getToken();
      if (!t) return;
      const fileId = await resolveFileId(t);
      const url = `https://graph.microsoft.com/v1.0/me/drive/items/${fileId}/workbook/tables/${EXCEL_TABLE}/rows`;
      const resp = await fetch(url, { headers: { Authorization: `Bearer ${t}` } });
      const data = await resp.json();
      if (!resp.ok) throw new Error(data.error?.message || resp.status);
      const loaded = (data.value || [])
        .map((row, i) => rowToBid(row.values[0], i))
        .filter(Boolean).filter(b => b.id);
      setBids(loaded);
    } catch (e) {
      console.error("Load error:", e);
      setSyncStatus("error");
    } finally {
      setLoading(false);
      setRefreshing(false);
    }
  }

  async function appendBid(bid) {
    setSyncStatus("");
    try {
      const t = await getToken();
      if (!t) return;
      const fileId = await resolveFileId(t);
      const url = `https://graph.microsoft.com/v1.0/me/drive/items/${fileId}/workbook/tables/${EXCEL_TABLE}/rows/add`;
      const resp = await fetch(url, {
        method: "POST",
        headers: { Authorization: `Bearer ${t}`, "Content-Type": "application/json" },
        body: JSON.stringify({ values: [bidToRow(bid)] })
      });
      const body = await resp.json();
      console.log("Append status:", resp.status, body);
      if (!resp.ok) throw new Error(body.error?.message || resp.status);
      setSyncStatus("saved");
      setTimeout(() => setSyncStatus(""), 3000);
    } catch (e) {
      console.error("Save error:", e);
      setSyncStatus("error");
    }
  }

  async function updateBidInExcel(bid) {
    if (bid._rowIndex === undefined) return;
    setSyncStatus("");
    try {
      const t = await getToken();
      if (!t) return;
      const fileId = await resolveFileId(t);
      const url = `https://graph.microsoft.com/v1.0/me/drive/items/${fileId}/workbook/tables/${EXCEL_TABLE}/rows/$/itemAt(index=${bid._rowIndex})`;
      const resp = await fetch(url, {
        method: "PATCH",
        headers: { Authorization: `Bearer ${t}`, "Content-Type": "application/json" },
        body: JSON.stringify({ values: [bidToRow(bid)] })
      });
      console.log("Update status:", resp.status);
      if (!resp.ok) {
        const body = await resp.json();
        throw new Error(body.error?.message || resp.status);
      }
      setSyncStatus("saved");
      setTimeout(() => setSyncStatus(""), 3000);
    } catch (e) {
      console.error("Update error:", e);
      setSyncStatus("error");
    }
  }

  async function handleSaveSettings(s) {
    setSettings(s);
    cacheSettings(s);
    await saveSettingsToExcel(s);
  }

  // Computed bids with all calculations
  const computed = useMemo(() => bids.map(b => calcBid(b, bids, settings)), [bids, settings]);
  const filtered = useMemo(() => computed.filter(b =>
    (filterStage === "All" || b.stage === filterStage) &&
    (filterGNG === "All" || b.goNoGo === filterGNG)
  ), [computed, filterStage, filterGNG]);

  async function handleAddBid(e) {
    e.preventDefault();
    const bid = {
      ...newBid,
      id: nextId(bids),
      contractValue: Number(newBid.contractValue),
      winProb: Number(newBid.winProb),
      targetMargin: Number(newBid.targetMargin),
      bidDurationWeeks: Number(newBid.bidDurationWeeks),
      awardDate: "",
    };
    setBids(prev => [...prev, { ...bid, _rowIndex: prev.length }]);
    await appendBid(bid);
    await loadBids(null, true);
    setNewBid({
      authority: "", name: "", region: REGIONS[0], stage: "Intake",
      bidStart: new Date().toISOString().slice(0, 10), bidDurationWeeks: 20,
      contractValue: "", winProb: "", targetMargin: "", strategicScore: 3,
      compliance: "Pass", decisionOwner: "", notes: ""
    });
    setView("Portfolio Grid");
  }

  // â”€â”€ Auth gate â”€â”€
  if (authState !== "authenticated") {
    return <LoginScreen onSignIn={handleSignIn} error={authError} loading={authState === "signing-in"} />;
  }
  if (loading) return <Spinner message="Loading bids from OneDriveâ€¦" />;

  // â”€â”€ Header â”€â”€
  const syncColor = syncStatus === "saved" ? "#4BE8A0" : syncStatus === "error" ? "#E84B7A" : "#9CA3AF";
  const syncLabel = syncStatus === "saved" ? "âœ“ Synced" : syncStatus === "error" ? "âœ• Sync error" : "";

  return (
    <div style={{ minHeight: "100vh", background: "#0a0d14", color: "#f0f2f8" }}>

      {/* Header */}
      <div style={{ background: "#111520", borderBottom: "1px solid #1e2435", padding: "0 28px", display: "flex", alignItems: "center", justifyContent: "space-between", height: 54, position: "sticky", top: 0, zIndex: 100 }}>
        <div style={{ display: "flex", alignItems: "center", gap: 14 }}>
          <div style={{ width: 30, height: 30, background: "linear-gradient(135deg,#4B9FE8,#A04BE8)", borderRadius: 7, display: "flex", alignItems: "center", justifyContent: "center", fontSize: 15 }}>ğŸšŒ</div>
          <span style={{ fontWeight: 800, fontSize: 14 }}>First Bus</span>
          <span style={{ color: "#1e2435", fontSize: 18 }}>|</span>
          <nav style={{ display: "flex", gap: 4 }}>
            {VIEWS.map(v => (
              <button key={v} onClick={() => setView(v)} style={{
                background: view === v ? "#1e2435" : "transparent",
                color: view === v ? "#f0f2f8" : "#9CA3AF",
                border: "none", borderRadius: 6, padding: "5px 12px", fontSize: 12,
                cursor: "pointer", fontWeight: view === v ? 700 : 400, fontFamily: "'Syne',sans-serif",
                transition: "all 0.15s"
              }}>{v}</button>
            ))}
          </nav>
        </div>
        <div style={{ display: "flex", alignItems: "center", gap: 12 }}>
          {syncLabel && <span style={{ fontSize: 11, color: syncColor, fontFamily: "'DM Mono',monospace" }}>{syncLabel}</span>}
          <button
            onClick={() => loadBids(null, true)}
            disabled={refreshing}
            title="Refresh data from OneDrive"
            style={{ background: "#1e2435", color: refreshing ? "#4B5563" : "#9CA3AF", border: "none", borderRadius: 6, padding: "5px 11px", fontSize: 15, cursor: refreshing ? "not-allowed" : "pointer", transition: "all 0.2s", lineHeight: 1 }}>
            <span style={{ display: "inline-block", animation: refreshing ? "spin 0.7s linear infinite" : "none" }}>â†»</span>
          </button>
          {accessToken && (
            <div style={{ display: "flex", alignItems: "center", gap: 8 }}>
              {userInfo && <span style={{ fontSize: 12, color: "#9CA3AF" }}>{userInfo.name}</span>}
              <button onClick={handleSignOut} style={{ background: "transparent", color: "#9CA3AF", border: "1px solid #1e2435", borderRadius: 6, padding: "4px 10px", fontSize: 11, cursor: "pointer", fontFamily: "'DM Mono',monospace" }}>Sign out</button>
            </div>
          )}
        </div>
      </div>

      <div style={{ padding: "28px 28px" }}>

        {/* â•â•â• SETTINGS â•â•â• */}
        {view === "Settings" && (
          <SettingsPage settings={settings} onSave={handleSaveSettings} />
        )}

        {/* â•â•â• DASHBOARD â•â•â• */}
        {view === "Dashboard" && (
          <div className="fade-in">
            <div style={{ marginBottom: 24 }}>
              <h1 style={{ fontSize: 22, fontWeight: 800, marginBottom: 4 }}>Portfolio Dashboard</h1>
              <p style={{ color: "#9CA3AF", fontSize: 12, fontFamily: "'DM Mono',monospace" }}>
                Franchise cycle 2026â€“2030 Â· {computed.length} bids tracked
              </p>
            </div>

            {/* KPI row */}
            <div style={{ display: "flex", gap: 14, flexWrap: "wrap", marginBottom: 24 }}>
              <KpiCard label="Active Bids" value={computed.filter(b => ["Intake","Qualified","Submitted"].includes(b.stage)).length} accent="#4B9FE8" />
              <KpiCard label="Pipeline EV" value={fmtCurrency(computed.reduce((s, b) => s + b.ev, 0))} accent="#4BE8A0" color="#4BE8A0" />
              <KpiCard label="GO" value={computed.filter(b => b.goNoGo === "GO").length} accent="#4BE8A0" color="#4BE8A0" />
              <KpiCard label="REVIEW" value={computed.filter(b => b.goNoGo === "REVIEW").length} accent="#E8B84B" color="#E8B84B" />
              <KpiCard label="NO-GO" value={computed.filter(b => b.goNoGo === "NO-GO").length} accent="#E84B7A" color="#E84B7A" />
              <KpiCard label="Won" value={computed.filter(b => b.stage === "Won").length} accent="#A04BE8" color="#A04BE8" />
            </div>

            {/* Stage breakdown */}
            <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: 16, marginBottom: 24 }}>
              <div style={{ background: "#111520", border: "1px solid #1e2435", borderRadius: 10, padding: "20px 24px" }}>
                <div style={{ fontSize: 10, color: "#9CA3AF", fontFamily: "'DM Mono',monospace", textTransform: "uppercase", letterSpacing: 1, marginBottom: 14 }}>Stage Breakdown</div>
                {STAGES.map(s => {
                  const count = computed.filter(b => b.stage === s).length;
                  const pct = computed.length ? (count / computed.length) * 100 : 0;
                  return (
                    <div key={s} style={{ marginBottom: 10 }}>
                      <div style={{ display: "flex", justifyContent: "space-between", marginBottom: 4 }}>
                        <span style={{ fontSize: 12, color: "#9CA3AF" }}>{s}</span>
                        <span style={{ fontSize: 12, fontFamily: "'DM Mono',monospace", color: StageColors[s] }}>{count}</span>
                      </div>
                      <div style={{ background: "#0d1119", borderRadius: 2, height: 3 }}>
                        <div style={{ width: `${pct}%`, background: StageColors[s], height: 3, borderRadius: 2, transition: "width 0.5s ease" }} />
                      </div>
                    </div>
                  );
                })}
              </div>
              <div style={{ background: "#111520", border: "1px solid #1e2435", borderRadius: 10, padding: "20px 24px" }}>
                <div style={{ fontSize: 10, color: "#9CA3AF", fontFamily: "'DM Mono',monospace", textTransform: "uppercase", letterSpacing: 1, marginBottom: 14 }}>Capacity Monitor</div>
                <div style={{ marginBottom: 16 }}>
                  <div style={{ fontSize: 12, color: "#9CA3AF", marginBottom: 6 }}>Active lead utilisation</div>
                  {(() => {
                    const active = computed.filter(b => ["Intake","Qualified"].includes(b.stage)).length;
                    const max = settings.concurrencyLimit;
                    const pct = Math.min((active / max) * 100, 100);
                    const over = active > max;
                    return (
                      <>
                        <div style={{ background: "#0d1119", borderRadius: 4, height: 8, marginBottom: 6 }}>
                          <div style={{ width: `${pct}%`, background: over ? "#E84B7A" : "#4BE8A0", height: 8, borderRadius: 4, transition: "width 0.5s" }} />
                        </div>
                        <div style={{ fontSize: 11, fontFamily: "'DM Mono',monospace", color: over ? "#E84B7A" : "#4BE8A0" }}>
                          {active} / {max} concurrent bids {over ? "âš  OVER CAPACITY" : ""}
                        </div>
                      </>
                    );
                  })()}
                </div>
                <div style={{ fontSize: 10, color: "#9CA3AF", fontFamily: "'DM Mono',monospace", textTransform: "uppercase", letterSpacing: 1, marginBottom: 10 }}>Won â€” Mobilisation</div>
                {computed.filter(b => b.stage === "Won").length === 0
                  ? <div style={{ fontSize: 12, color: "#4B5563" }}>No won bids yet</div>
                  : computed.filter(b => b.stage === "Won").map(b => (
                    <div key={b.id} style={{ marginBottom: 8, padding: "8px 10px", background: "#0d1119", borderRadius: 6 }}>
                      <div style={{ fontSize: 12, fontWeight: 600, marginBottom: 2 }}>{b.name}</div>
                      <span style={{ fontSize: 11, color: "#9CA3AF", fontFamily: "'DM Mono',monospace" }}>Go-Live: {fmtDate(b.goLiveDate)}</span>
                    </div>
                  ))
                }
              </div>
            </div>

            {/* Pursuit cost summary */}
            <div style={{ background: "#111520", border: "1px solid #1e2435", borderRadius: 10, padding: "18px 24px" }}>
              <div style={{ fontSize: 10, color: "#9CA3AF", fontFamily: "'DM Mono',monospace", textTransform: "uppercase", letterSpacing: 1, marginBottom: 12 }}>Pursuit Cost Summary</div>
              <div style={{ display: "flex", gap: 28, flexWrap: "wrap" }}>
                <div><div style={{ fontSize: 11, color: "#9CA3AF", marginBottom: 4 }}>Total pursuit cost</div><div style={{ fontSize: 20, fontWeight: 800, color: "#E8B84B" }}>{fmtGBP(computed.reduce((s, b) => s + b.bidPursuitCost, 0))}</div></div>
                <div><div style={{ fontSize: 11, color: "#9CA3AF", marginBottom: 4 }}>Blended rate</div><div style={{ fontSize: 20, fontWeight: 800 }}>Â£{settings.blendedRate}/hr</div></div>
                <div><div style={{ fontSize: 11, color: "#9CA3AF", marginBottom: 4 }}>Total bid hours</div><div style={{ fontSize: 20, fontWeight: 800 }}>{computed.reduce((s, b) => s + b.totalHours, 0).toLocaleString()} hrs</div></div>
                <div><div style={{ fontSize: 11, color: "#9CA3AF", marginBottom: 4 }}>Win rate</div><div style={{ fontSize: 20, fontWeight: 800, color: "#4BE8A0" }}>{computed.length ? `${Math.round(computed.filter(b=>b.stage==="Won").length/computed.length*100)}%` : "â€”"}</div></div>
              </div>
            </div>
          </div>
        )}

        {/* â•â•â• PORTFOLIO GRID â•â•â• */}
        {view === "Portfolio Grid" && (
          <div className="fade-in">
            <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", marginBottom: 20 }}>
              <div>
                <h1 style={{ fontSize: 22, fontWeight: 800, marginBottom: 4 }}>Portfolio Grid</h1>
                <p style={{ color: "#9CA3AF", fontSize: 12, fontFamily: "'DM Mono',monospace" }}>{filtered.length} bids</p>
              </div>
              <div style={{ display: "flex", gap: 10 }}>
                <select value={filterStage} onChange={e => setFilterStage(e.target.value)} style={{ ...inp({ width: "auto" }) }}>
                  <option value="All">All Stages</option>
                  {STAGES.map(s => <option key={s}>{s}</option>)}
                </select>
                <select value={filterGNG} onChange={e => setFilterGNG(e.target.value)} style={{ ...inp({ width: "auto" }) }}>
                  <option value="All">All Outcomes</option>
                  {["GO","REVIEW","NO-GO","WON","LOST"].map(g => <option key={g}>{g}</option>)}
                </select>
                <button onClick={() => loadBids()} style={{ background: "#1e2435", color: "#9CA3AF", border: "none", borderRadius: 7, padding: "8px 14px", fontSize: 12, cursor: "pointer" }}>â†» Refresh</button>
              </div>
            </div>

            <div style={{ background: "#111520", border: "1px solid #1e2435", borderRadius: 10, overflow: "hidden" }}>
              <div style={{ overflowX: "auto" }}>
                <table style={{ width: "100%", borderCollapse: "collapse", fontSize: 12, minWidth: 1050 }}>
                  <thead>
                    <tr style={{ background: "#0d1119", borderBottom: "1px solid #1e2435" }}>
                      {["ID","Opportunity","Authority","Stage","Due Date","Contract Val","Win%","EV","Pursuit Cost","Bid Cost%","Go/No-Go","Cap","Flags"].map(h => (
                        <th key={h} style={{ padding: "10px 13px", textAlign: "left", color: "#9CA3AF", fontFamily: "'DM Mono',monospace", fontSize: 10, fontWeight: 500, textTransform: "uppercase", letterSpacing: 0.8, whiteSpace: "nowrap" }}>{h}</th>
                      ))}
                    </tr>
                  </thead>
                  <tbody>
                    {filtered.map(b => (
                      <React.Fragment key={b.id}>
                        <tr
                          onClick={() => {
                          const next = selectedBid?.id === b.id ? null : b;
                          setSelectedBid(next);
                          setEditDraft(next ? { ...next } : null);
                          setConfirmDeleteId(null);
                        }}
                          style={{ borderBottom: "1px solid #151d2e", cursor: "pointer", background: selectedBid?.id === b.id ? "#161f30" : "transparent", transition: "background 0.15s" }}
                          onMouseEnter={e => { if (selectedBid?.id !== b.id) e.currentTarget.style.background = "#121a27"; }}
                          onMouseLeave={e => { if (selectedBid?.id !== b.id) e.currentTarget.style.background = "transparent"; }}>
                          <td style={{ padding: "11px 13px", fontFamily: "'DM Mono',monospace", color: "#9CA3AF", fontSize: 11 }}>{b.id}</td>
                          <td style={{ padding: "11px 13px", fontWeight: 600, maxWidth: 180, overflow: "hidden", textOverflow: "ellipsis", whiteSpace: "nowrap" }}>{b.name}</td>
                          <td style={{ padding: "11px 13px", color: "#9CA3AF" }}>{b.authority}</td>
                          <td style={{ padding: "11px 13px" }}><Badge label={b.stage} color={StageColors[b.stage] || "#64748b"} small /></td>
                          <td style={{ padding: "11px 13px", fontFamily: "'DM Mono',monospace", fontSize: 11 }}>{fmtDate(b.bidEnd)}</td>
                          <td style={{ padding: "11px 13px" }}>{fmtCurrency(b.contractValue)}</td>
                          <td style={{ padding: "11px 13px" }}>{b.winProb}%</td>
                          <td style={{ padding: "11px 13px", color: "#4BE8A0" }}>{fmtCurrency(b.ev)}</td>
                          <td style={{ padding: "11px 13px", color: "#E8B84B" }}>{fmtCurrency(b.bidPursuitCost)}</td>
                          <td style={{ padding: "11px 13px", fontFamily: "'DM Mono',monospace", color: b.bidCostPct > settings.maxBidCostPct ? "#E84B7A" : "#9CA3AF" }}>
                            {b.bidCostPct > 99 ? "â€”" : b.bidCostPct.toFixed(1) + "%"}
                          </td>
                          <td style={{ padding: "11px 13px" }}><Badge label={b.goNoGo} color={GOColors[b.goNoGo] || "#64748b"} /></td>
                          <td style={{ padding: "11px 13px" }}><Badge label={b.capacityStatus} color={CapColor[b.capacityStatus]} small /></td>
                          <td style={{ padding: "11px 13px" }}>
                            {b.flags.length ? <span style={{ color: "#E8B84B", fontSize: 11 }}>âš  {b.flags.length}</span> : <span style={{ color: "#1e2435" }}>â€”</span>}
                          </td>
                        </tr>

                        {selectedBid?.id === b.id && (
                          <tr>
                            <td colSpan={13} style={{ background: "#0d1119", borderBottom: "1px solid #1e2435", padding: 0 }}>
                              <div className="fade-in" style={{ padding: "20px 24px", display: "flex", gap: 28, flexWrap: "wrap" }}>

                                {/* Full inline edit form â€” state lives at App level */}
                                {editDraft && editDraft.id === b.id && (() => {
                                  const isDirty = JSON.stringify(editDraft) !== JSON.stringify(b);

                                  async function handleSaveEdit(e) {
                                    e.stopPropagation();
                                    const updated = {
                                      ...editDraft,
                                      contractValue: Number(editDraft.contractValue),
                                      winProb: Number(editDraft.winProb),
                                      targetMargin: Number(editDraft.targetMargin),
                                      bidDurationWeeks: Number(editDraft.bidDurationWeeks),
                                      strategicScore: Number(editDraft.strategicScore),
                                    };
                                    setBids(prev => prev.map(x => x.id === updated.id ? updated : x));
                                    setSelectedBid(updated);
                                    setEditDraft(updated);
                                    await updateBidInExcel(updated);
                                  }

                                  async function handleDelete(e) {
                                    e.stopPropagation();
                                    await deleteBidFromExcel(b);
                                    setBids(prev => prev.filter(x => x.id !== b.id).map((x, i) => ({ ...x, _rowIndex: i })));
                                    setSelectedBid(null);
                                    setEditDraft(null);
                                    setConfirmDeleteId(null);
                                  }

                                  const fld = (key, label, type, opts) => (
                                    <div key={key} onClick={e => e.stopPropagation()}>
                                      <label style={lbl()}>{label}</label>
                                      {type === "select"
                                        ? <select value={editDraft[key] || ""} onChange={e => setEditDraft(p => ({ ...p, [key]: e.target.value }))} style={{ ...inp(), fontSize: 12 }}>
                                            {opts.map(o => <option key={o}>{o}</option>)}
                                          </select>
                                        : <input type={type} value={editDraft[key] || ""} onChange={e => setEditDraft(p => ({ ...p, [key]: e.target.value }))} style={{ ...inp(), fontSize: 12 }} />
                                      }
                                    </div>
                                  );

                                  return (
                                    <div style={{ width: "100%" }}>
                                      <div style={{ display: "grid", gridTemplateColumns: "repeat(auto-fill, minmax(180px, 1fr))", gap: 12, marginBottom: 16 }}>
                                        {fld("name", "Opportunity Name", "text")}
                                        {fld("authority", "Authority / Client", "text")}
                                        {fld("region", "Region", "select", REGIONS)}
                                        {fld("stage", "Stage", "select", STAGES)}
                                        {fld("decisionOwner", "Decision Owner", "text")}
                                        {fld("compliance", "Compliance", "select", COMPLIANCE_OPTS)}
                                        {fld("bidStart", "Bid Start", "date")}
                                        {fld("bidDurationWeeks", "Duration (Weeks)", "number")}
                                        {fld("contractValue", "Contract Value (Â£)", "number")}
                                        {fld("winProb", "Win Probability (%)", "number")}
                                        {fld("targetMargin", "Target Margin (%)", "number")}
                                        {fld("strategicScore", "Strategic Score (1â€“5)", "number")}
                                        {fld("awardDate", "Award Date", "date")}
                                        {fld("notes", "Notes", "text")}
                                      </div>

                                      {b.stage === "Won" && b.mobilisationStart && (
                                        <div style={{ display: "flex", gap: 16, marginBottom: 14, padding: "8px 12px", background: "#111520", borderRadius: 6, border: "1px solid #1e2435" }}>
                                          <span style={{ fontSize: 11, color: "#4BE8A0", fontFamily: "'DM Mono',monospace" }}>Mob Start: {fmtDate(b.mobilisationStart)}</span>
                                          <span style={{ fontSize: 11, color: "#4BE8A0", fontFamily: "'DM Mono',monospace" }}>Go-Live: {fmtDate(b.goLiveDate)}</span>
                                        </div>
                                      )}

                                      {b.flags.length > 0 && (
                                        <div style={{ display: "flex", gap: 10, flexWrap: "wrap", marginBottom: 14 }}>
                                          {b.flags.map(f => <span key={f} style={{ fontSize: 11, color: "#E8B84B" }}>âš  {f}</span>)}
                                        </div>
                                      )}

                                      <div style={{ display: "flex", gap: 10, alignItems: "center" }} onClick={e => e.stopPropagation()}>
                                        <button
                                          onClick={handleSaveEdit}
                                          disabled={!isDirty}
                                          style={{ background: isDirty ? "#4B9FE8" : "#1e2435", color: isDirty ? "#fff" : "#4B5563", border: "none", borderRadius: 7, padding: "8px 18px", fontSize: 12, fontWeight: 700, cursor: isDirty ? "pointer" : "not-allowed", transition: "all 0.2s" }}>
                                          Save Changes
                                        </button>
                                        {confirmDeleteId !== b.id
                                          ? <button onClick={e => { e.stopPropagation(); setConfirmDeleteId(b.id); }} style={{ background: "transparent", color: "#E84B7A", border: "1px solid #E84B7A33", borderRadius: 7, padding: "8px 16px", fontSize: 12, cursor: "pointer" }}>Delete Bid</button>
                                          : <div style={{ display: "flex", gap: 8, alignItems: "center" }}>
                                              <span style={{ fontSize: 12, color: "#E84B7A" }}>Confirm delete?</span>
                                              <button onClick={handleDelete} style={{ background: "#E84B7A", color: "#fff", border: "none", borderRadius: 7, padding: "7px 14px", fontSize: 12, fontWeight: 700, cursor: "pointer" }}>Yes, delete</button>
                                              <button onClick={e => { e.stopPropagation(); setConfirmDeleteId(null); }} style={{ background: "transparent", color: "#9CA3AF", border: "1px solid #1e2435", borderRadius: 7, padding: "7px 12px", fontSize: 12, cursor: "pointer" }}>Cancel</button>
                                            </div>
                                        }
                                      </div>
                                    </div>
                                  );
                                })()}

                              </div>
                            </td>
                          </tr>
                        )}
                      </React.Fragment>
                    ))}
                    {filtered.length === 0 && (
                      <tr><td colSpan={13} style={{ padding: "28px 16px", color: "#9CA3AF", fontSize: 13, textAlign: "center" }}>No bids match your filters.</td></tr>
                    )}
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        )}

        {/* â•â•â• ADD BID â•â•â• */}
        {view === "Add Bid" && (
          <div className="fade-in" style={{ maxWidth: 760 }}>
            <h1 style={{ fontSize: 22, fontWeight: 800, marginBottom: 6 }}>Intake â€” New Bid</h1>
            <p style={{ color: "#9CA3AF", fontSize: 12, fontFamily: "'DM Mono',monospace", marginBottom: 28 }}>
              Complete intake fields. Go/No-Go calculated live. Saved directly to OneDrive Excel.
            </p>

            <form onSubmit={handleAddBid}>
              <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: 16, marginBottom: 20 }}>
                {[
                  { key: "name", label: "Opportunity Name", type: "text", full: true },
                  { key: "authority", label: "Authority / Client", type: "text" },
                  { key: "region", label: "Region", type: "select", opts: REGIONS },
                  { key: "stage", label: "Stage", type: "select", opts: STAGES },
                  { key: "decisionOwner", label: "Decision Owner", type: "text" },
                  { key: "compliance", label: "Compliance", type: "select", opts: COMPLIANCE_OPTS },
                  { key: "bidStart", label: "Bid Start Date", type: "date" },
                  { key: "bidDurationWeeks", label: "Bid Duration (Weeks)", type: "number" },
                  { key: "contractValue", label: "Est. Contract Value (Â£)", type: "number" },
                  { key: "winProb", label: "Win Probability (%)", type: "number" },
                  { key: "targetMargin", label: "Target Margin (%)", type: "number" },
                  { key: "strategicScore", label: "Strategic Score (1â€“5)", type: "number" },
                  { key: "notes", label: "Notes", type: "text", full: true },
                ].map(({ key, label, type, opts, full }) => (
                  <div key={key} style={full ? { gridColumn: "1 / -1" } : {}}>
                    <label style={lbl()}>{label}</label>
                    {type === "select"
                      ? <select value={newBid[key]} onChange={e => setNewBid(p => ({ ...p, [key]: e.target.value }))} style={inp()}>{opts.map(o => <option key={o}>{o}</option>)}</select>
                      : <input type={type} value={newBid[key]} onChange={e => setNewBid(p => ({ ...p, [key]: e.target.value }))} style={inp()} />}
                  </div>
                ))}
              </div>

              {/* Live preview */}
              {newBid.contractValue && newBid.winProb && (() => {
                const preview = calcBid({ ...newBid, id: "PREVIEW", contractValue: Number(newBid.contractValue), winProb: Number(newBid.winProb), targetMargin: Number(newBid.targetMargin), bidDurationWeeks: Number(newBid.bidDurationWeeks), awardDate: "" }, bids, settings);
                const gngColor = GOColors[preview.goNoGo] || "#64748b";
                return (
                  <div style={{ background: "#0d1119", border: `1px solid ${gngColor}44`, borderRadius: 10, padding: "18px 24px", marginBottom: 20 }}>
                    <div style={{ fontSize: 10, color: "#9CA3AF", fontFamily: "'DM Mono',monospace", marginBottom: 12, textTransform: "uppercase", letterSpacing: 1 }}>Live Viability Preview</div>
                    <div style={{ display: "flex", gap: 24, flexWrap: "wrap", alignItems: "center" }}>
                      <div><div style={{ fontSize: 10, color: "#9CA3AF", marginBottom: 4 }}>OUTCOME</div><Badge label={preview.goNoGo} color={gngColor} /></div>
                      <div style={{ fontSize: 12 }}><span style={{ color: "#9CA3AF" }}>EV: </span><span style={{ color: "#4BE8A0", fontFamily: "'DM Mono',monospace" }}>{fmtGBP(preview.ev)}</span></div>
                      <div style={{ fontSize: 12 }}><span style={{ color: "#9CA3AF" }}>Pursuit Cost: </span><span style={{ color: "#E8B84B", fontFamily: "'DM Mono',monospace" }}>{fmtGBP(preview.bidPursuitCost)}</span></div>
                      <div style={{ fontSize: 12 }}><span style={{ color: "#9CA3AF" }}>Due: </span><span style={{ fontFamily: "'DM Mono',monospace" }}>{fmtDate(preview.bidEnd)}</span></div>
                      <div style={{ fontSize: 12 }}><span style={{ color: "#9CA3AF" }}>Capacity: </span><Badge label={preview.capacityStatus} color={CapColor[preview.capacityStatus]} small /></div>
                      {preview.flags.map(f => <span key={f} style={{ fontSize: 11, color: "#E8B84B" }}>âš  {f}</span>)}
                    </div>
                  </div>
                );
              })()}

              <button type="submit" style={{ background: "linear-gradient(135deg,#4B9FE8,#A04BE8)", color: "#fff", border: "none", borderRadius: 8, padding: "13px 28px", fontSize: 14, fontWeight: 700, cursor: "pointer" }}>
                Add to Portfolio â†’ Save to OneDrive
              </button>
            </form>
          </div>
        )}

      </div>
    </div>
  );
}

ReactDOM.render(<App />, document.getElementById("root"));
</script>
</body>
</html>
